<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reviz√°k Scan Pro ‚Äì v2.6 FINAL</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #333; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 15px; background: #f4f4f9; -webkit-tap-highlight-color: transparent; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.85rem; color: #555; }
        input, select { width: 100%; padding: 12px; margin: 5px 0 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; color: white; margin-bottom: 10px; }
        .btn-success { background: var(--success); }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: none; color: #666; border: 1px solid #ccc; }
        #reader { width: 100%; max-width: 300px; margin: 15px auto; border-radius: 12px; overflow: hidden; background: #000; border: 2px solid #ddd; }
        .hidden { display: none; }
        .flex-row { display: flex; gap: 10px; }
        .id-error { border: 2px solid var(--danger) !important; color: var(--danger); }
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="setup-step">
    <div class="card">
        <h2>1. Nahr√°t origin√°l z Illka</h2>
        <input type="file" id="csv-file" accept=".csv">
    </div>
</div>

<div id="scan-step" class="hidden">
    <div class="header-box">
        <h2 style="margin:0;">Skenovat</h2>
        <button onclick="openAddModal()" style="width:auto; padding:10px 20px; margin:0;" class="btn-primary">+ Nov√Ω spot≈ôebiƒç</button>
    </div>
    <div class="card" style="text-align: center;">
        <div id="reader"></div>
        <button onclick="restartScanner()" class="btn-outline" style="padding: 8px; font-size: 0.8rem; width: auto; margin-bottom: 15px;">üîÑ Restartovat kameru</button>
        <input type="text" id="manual-search" placeholder="Zadejte ID ruƒçnƒõ...">
        <button class="btn-primary" onclick="searchById(document.getElementById('manual-search').value)">Hledat</button>
    </div>
    <button onclick="downloadFinalCSV()" style="background:var(--dark); height: 60px;">3. GENEROVAT EXPORT (CSV)</button>
    <button onclick="manualReset()" class="btn-outline" style="color:var(--danger); border-color:var(--danger); margin-top:40px;">RESETOVAT DATA</button>
</div>

<div id="form-step" class="hidden">
    <div class="card">
        <h3>ID: <span id="display-id" style="color:var(--primary)"></span> (<span id="display-class"></span>)</h3>
        <p id="display-name" style="font-weight:bold; margin-top:-10px; color:#333;"></p>
        <hr>
        <label>Rpe (Odpor ochrann√©ho vodiƒçe)</label>
        <input type="text" id="field-Rpe" inputmode="decimal">
        <label>IdifEq (Unikaj√≠c√≠ proud PE)</label>
        <input type="text" id="field-IdifEq" inputmode="decimal">
        <label>IdifTouch (Dotykov√Ω proud)</label>
        <input type="text" id="field-IdifTouch" inputmode="decimal">
        <label>RisoM_PE (Izolaƒçn√≠ odpor)</label>
        <input type="text" id="field-Riso" value=">19,99">
        
        <div class="flex-row" style="margin-top:20px;">
            <button class="btn-danger" style="flex: 1;" onclick="saveData(true)">KO (Z√°vada)</button>
            <button class="btn-success" style="flex: 2;" onclick="saveData(false)">ULO≈ΩIT OK</button>
        </div>
        <button class="btn-outline" onclick="showScan()">ZPƒöT</button>
    </div>
</div>

<div id="add-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; overflow-y:auto; padding:15px; box-sizing:border-box;">
    <div class="card">
        <h3>Nov√Ω spot≈ôebiƒç</h3>
        <label>ID ƒå√≠slo (IdText)</label>
        <input type="text" id="new-IdText" oninput="validateNewId(this.value)">
        <label>N√°zev spot≈ôebiƒçe</label>
        <input type="text" id="new-Name">
        <label>Kategorie</label>
        <select id="new-Category">
            <option>ƒåSN 33 1600 ed.2 - Spot≈ôebiƒçe</option>
            <option>ƒåSN EN 60974-4 ed.2 ‚Äì Sv√°≈ôeƒçky</option>
            <option>ƒåSN EN 60204-1 ed.2 ‚Äì El. za≈ô√≠zen√≠ stroj≈Ø</option>
        </select>
        <div class="flex-row">
            <div style="flex:1"><label>T≈ô√≠da</label><select id="new-MeasClass"><option>I</option><option>II</option><option>III</option></select></div>
            <div style="flex:1"><label>Skupina</label><select id="new-MeasGroup"><option>A</option><option>B</option><option>C</option><option>D</option><option>E</option></select></div>
        </div>
        <label>Typ (EquipType)</label>
        <select id="new-EquipType"><option>Nep≈ôipevnƒõn√Ω</option><option>Dr≈æen√Ω v ruce</option><option>P≈ôipevnƒõn√Ω</option></select>
        <label>P≈ôipojen√≠ (Connection)</label>
        <select id="new-Connection"><option>Vidlic√≠ 230V</option><option>Vidlic√≠ 3 x 400V</option><option>Trval√© p≈ôipojen√≠ 230V</option><option>Trval√© p≈ôipojen√≠ 3 x 400V</option></select>
        <div class="flex-row">
            <div style="flex:1"><label
