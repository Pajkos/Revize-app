<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Revizák Scan Pro – AutoFill</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --dark: #333; }
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 15px; background: #f4f4f9; -webkit-tap-highlight-color: transparent; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.85rem; color: #555; }
        input, select { width: 100%; padding: 12px; margin: 5px 0 10px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; color: white; margin-bottom: 10px; }
        .btn-success { background: var(--success); }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: none; color: #666; border: 1px solid #ccc; }
        
        /* Zmenšený skener */
        #reader { width: 100%; max-width: 300px; margin: 15px auto; border-radius: 12px; overflow: hidden; background: #000; border: 2px solid #ddd; }
        
        .hidden { display: none; }
        .flex-row { display: flex; gap: 10px; }
        .id-error { border: 2px solid var(--danger) !important; color: var(--danger); }
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="setup-step">
    <div class="card">
        <h2>1. Nahrát originál z Illka</h2>
        <input type="file" id="csv-file" accept=".csv">
    </div>
</div>

<div id="scan-step" class="hidden">
    <div class="header-box">
        <h2 style="margin:0;">Skenovat</h2>
        <button onclick="openAddModal()" style="width:auto; padding:10px 20px; margin:0;" class="btn-primary">+ Nový spotřebič</button>
    </div>
    <div class="card" style="text-align: center;">
        <div id="reader"></div>
        <input type="text" id="manual-search" placeholder="Zadejte ID ručně...">
        <button class="btn-primary" onclick="searchById(document.getElementById('manual-search').value)">Hledat</button>
    </div>
    <button onclick="downloadFinalCSV()" style="background:var(--dark); height: 60px;">3. GENEROVAT EXPORT (CSV)</button>
    <button onclick="manualReset()" class="btn-outline" style="color:var(--danger); border-color:var(--danger); margin-top:40px;">RESETOVAT DATA</button>
</div>

<div id="form-step" class="hidden">
    <div class="card">
        <h3>ID: <span id="display-id" style="color:var(--primary)"></span></h3>
        <p id="display-name" style="font-weight:bold; margin-top:-10px; color:#333;"></p>
        <hr>
        <label>Rpe (Odpor ochranného vodiče)</label>
        <input type="text" id="field-Rpe" inputmode="decimal" placeholder="např. 0,05">
        <label>IdifEq (Unikající proud)</label>
        <input type="text" id="field-IdifEq" inputmode="decimal" placeholder="např. 0,12">
        <label>RisoM_PE (Izolační odpor)</label>
        <input type="text" id="field-Riso" value=">19,99">
        
        <div class="flex-row" style="margin-top:20px;">
            <button class="btn-danger" style="flex: 1;" onclick="saveData(true)">KO (Závada)</button>
            <button class="btn-success" style="flex: 2;" onclick="saveData(false)">ULOŽIT OK</button>
        </div>
        <button class="btn-outline" onclick="showScan()">ZPĚT BEZ ULOŽENÍ</button>
    </div>
</div>

<div id="add-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; overflow-y:auto; padding:15px; box-sizing:border-box;">
    <div class="card">
        <h3 style="margin-top:0;">Nový spotřebič</h3>
        <label>ID Číslo (IdText)</label>
        <input type="text" id="new-IdText" oninput="validateNewId(this.value)">
        <label>Název spotřebiče</label>
        <input type="text" id="new-Name" placeholder="např. Prodlužka 3m">
        <label>Kategorie</label>
        <select id="new-Category">
            <option>ČSN 33 1600 ed.2 - Spotřebiče</option>
            <option>ČSN EN 60974-4 ed.2 – Svářečky</option>
            <option>ČSN EN 60204-1 ed.2 – El. zařízení strojů</option>
        </select>
        <label>Typ (EquipType)</label>
        <select id="new-EquipType">
            <option>Nepřipevněný</option>
            <option>Držený v ruce</option>
            <option>Připevněný</option>
        </select>
        <label>Připojení (Connection)</label>
        <select id="new-Connection">
            <option>Vidlicí 230V</option>
            <option>Vidlicí 3 x 400V</option>
            <option>Trvalé připojení 230V</option>
            <option>Trvalé připojení 3 x 400V</option>
        </select>
        <div class="flex-row">
            <div style="flex:1">
                <label>Třída</label>
                <select id="new-MeasClass"><option>I</option><option>II</option><option>III</option></select>
            </div>
            <div style="flex:1">
                <label>Skupina</label>
                <select id="new-MeasGroup"><option>A</option><option>B</option><option>C</option><option>D</option><option>E</option></select>
            </div>
        </div>
        <div class="flex-row">
            <div style="flex:1">
                <label>Délka (m)</label>
                <input type="number" id="new-CableLen" value="1.5">
            </div>
            <div style="flex:1">
                <label>Interval (měs)</label>
                <input type="number" id="new-Interval" value="24">
            </div>
        </div>
        <label>Místnost (Tree1)</label>
        <input type="text" id="new-Tree1" placeholder="např. Dílna">
        
        <button class="btn-success" onclick="addNewItem()">ULOŽIT NOVÝ</button>
        <button class="btn-outline" onclick="closeAddModal()">ZRUŠIT</button>
    </div>
</div>

<script>
    const MOJE_UDAJE = {
        TechName: "Pavel",
        TechSurname: "Král",
        TechLicence: "5288/25/R-EZ-E2A",
        TechPhone: "732362287",
        TechEmail: "pavel.kral96@seznam.cz",
        DevName: "BENNING ST 710",
        DevSerialNumber: "48N-0093"
    };

    let csvData = [];
    let csvHeaders = [];
    let currentIndex = -1;
    let scanner = new Html5Qrcode("reader");

    window.onload = () => {
        const d = localStorage.getItem('revize_data');
        const h = localStorage.getItem('revize_headers');
        if (d && h) {
            csvData = JSON.parse(d);
            csvHeaders = JSON.parse(h);
            document.getElementById('setup-step').classList.add('hidden');
            document.getElementById('scan-step').classList.remove('hidden');
            setTimeout(startScanner, 500);
        }
    };

    document.getElementById('csv-file').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            Papa.parse(event.target.result, {
                header: true, skipEmptyLines: false, delimiter: ";",
                complete: function(results) {
                    csvData = results.data.map(row => ({...row, _wasMeasured: false}));
                    csvHeaders = results.meta.fields; 
                    localStorage.setItem('revize_data', JSON.stringify(csvData));
                    localStorage.setItem('revize_headers', JSON.stringify(csvHeaders));
                    location.reload(); 
                }
            });
        };
        reader.readAsText(file, 'windows-1250');
    };

    function startScanner() {
        scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: 200 }, (t) => {
            scanner.pause(true); 
            searchById(t);
        }).catch(err => console.log("Chyba kamery: ", err));
    }

    function searchById(id) {
        const idx = csvData.findIndex(r => String(r.IdText).trim() === String(id).trim());
        if (idx !== -1) openForm(idx);
        else { alert("ID " + id + " nebylo v databázi nalezeno."); if(scanner.getState() === 3) scanner.resume(); }
    }

    function openForm(idx) {
        currentIndex = idx;
        const row = csvData[idx];
        document.getElementById('display-id').innerText = row.IdText || "";
        document.getElementById('display-name').innerText = row.Name || "";
        document.getElementById('field-Rpe').value = row.Rpe || "";
        document.getElementById('field-IdifEq').value = row.IdifEq || "";
        document.getElementById('scan-step').classList.add('hidden');
        document.getElementById('form-step').classList.remove('hidden');
        setTimeout(() => { document.getElementById('field-Rpe').focus(); }, 300);
    }

    function saveData(isFailed) {
        const row = csvData[currentIndex];
        const now = new Date();
        const dateStr = now.toLocaleDateString('cs-CZ').replace(/\s/g, '') + " 0:00:00";
        
        row._wasMeasured = true;
        row.LastRev = dateStr;
        row.Date = dateStr;
        row.Time = now.toLocaleTimeString('cs-CZ');
        row.Rpe = document.getElementById('field-Rpe').value;
        row.IdifEq = document.getElementById('field-IdifEq').value;
        row.RisoM_PE = document.getElementById('field-Riso').value;

        if (isFailed) {
            const reason = prompt("Zadejte POPIS ZÁVADY (MeasNote):");
            row.Result = "Failed";
            row.ResultTotal = "Failed";
            row.ResultVisual = "Failed";
            row.ResultFunct = "Failed";
            row.ResultMeas = "Failed";
            row.MeasNote = reason || "Nevyhovuje";
            row.Note = reason || "Nevyhovuje";
        } else {
            row.Result = "Passed";
            row.ResultTotal = "Passed";
            row.ResultVisual = "Passed";
            row.ResultFunct = "Passed";
            row.ResultMeas = "Passed";
            row.MeasNote = "";
            row.Note = "";
        }

        Object.assign(row, MOJE_UDAJE);
        
        if(row.Interval) {
            let next = new Date();
            next.setMonth(next.getMonth() + parseInt(row.Interval));
            row.NextRev = next.toLocaleDateString('cs-CZ').replace(/\s/g, '') + " 0:00:00";
        }

        localStorage.setItem('revize_data', JSON.stringify(csvData));
        showScan();
    }

    function openAddModal() { document.getElementById('add-modal').classList.remove('hidden'); }
    function closeAddModal() { document.getElementById('add-modal').classList.add('hidden'); }

    function validateNewId(id) {
        const exists = csvData.some(r => String(r.IdText).trim() === String(id).trim());
        const input = document.getElementById('new-IdText');
        if (exists) input.classList.add('id-error');
        else input.classList.remove('id-error');
    }

    function addNewItem() {
        const id = document.getElementById('new-IdText').value;
        if (csvData.some(r => String(r.IdText).trim() === String(id).trim())) return alert("Tento spotřebič již v seznamu existuje!");
        
        const newItem = {};
        csvHeaders.forEach(h => newItem[h] = "");
        
        newItem.IdText = id;
        newItem.Name = document.getElementById('new-Name').value;
        newItem.Category = document.getElementById('new-Category').value;
        newItem.EquipType = document.getElementById('new-EquipType').value;
        newItem.Connection = document.getElementById('new-Connection').value;
        newItem.MeasClass = document.getElementById('new-MeasClass').value;
        newItem.MeasGroup = document.getElementById('new-MeasGroup').value;
        newItem.CableLen = document.getElementById('new-CableLen').value;
        newItem.Interval = document.getElementById('new-Interval').value;
        newItem.Tree1 = document.getElementById('new-Tree1').value;
        newItem._wasMeasured = false;

        csvData.push(newItem);
        localStorage.setItem('revize_data', JSON.stringify(csvData));
        closeAddModal();
        searchById(id);
    }

    function showScan() {
        document.getElementById('form-step').classList.add('hidden');
        document.getElementById('scan-step').classList.remove('hidden');
        if(scanner.getState() === 3) scanner.resume();
    }

    function downloadFinalCSV() {
        let csvRows = [csvHeaders.join(';')];
        
        // Seznam polí, která se mají smazat u nenalezených (měření)
        const measurementFields = ["Rpe", "RisoM_PE", "IdifEq", "Rpe10A", "U10A", "IdifEqR", "IdifEqPE", "IdifEqPER", "IdifExt", "IdifTouch"];

        csvData.forEach(row => {
            let finalRow = {...row};
            
            if (!finalRow._wasMeasured) {
                // LOGIKA NENALEZENO
                finalRow.LastRev = "01.01.1970 0:00:00";
                finalRow.Date = "01.01.1970 0:00:00";
                finalRow.Result = "Neprovedeno";
                finalRow.ResultTotal = "Neprovedeno";
                finalRow.Note = "Nenalezeno";
                finalRow.MeasNote = "Nenalezeno";
                // Smazání hodnot měření
                measurementFields.forEach(f => { if(finalRow[f] !== undefined) finalRow[f] = ""; });
            }

            let values = csvHeaders.map(header => {
                let val = finalRow[header] === undefined || finalRow[header] === null ? "" : String(finalRow[header]);
                return (val === "" || /^[0-9,.]+$/.test(val.replace('>', '')) || val.includes(':')) ? val : `"${val}"`;
            });
            csvRows.push(values.join(';'));
        });
        
        const BOM = "\uFEFF";
        const blob = new Blob([BOM + csvRows.join('\r\n')], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "export_illko_final.csv";
        link.click();
    }

    function manualReset() {
        if(confirm("Opravdu smazat všechna data z paměti?")) { localStorage.clear(); location.reload(); }
    }
</script>
</body>
</html>
